<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
			
		
		<title>Writing Mac Apps in Go &middot; Young Dynasty</title>
		<meta property="og:title" content="Writing Mac Apps in Go &middot; Young Dynasty">
		
		<meta name="description" content="A guide for embedding Go within native macOS applications.">
		<meta name="og:description" content="A guide for embedding Go within native macOS applications.">
		
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://youngdynasty.net/posts/writing-mac-apps-in-go/">

		
  		<link rel="stylesheet" href="/css/style.css">
  		<link rel="stylesheet" href="/css/custom.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
	
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
	
		
		<link href="" rel="alternate" type="application/rss+xml" title="Young Dynasty" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Young Dynasty</h2>
				</a>
				<ul>
    <li><a href="https://emporter.app">Emporter</a></li>
    <li>|</li>
    <li><a href="/about">About Me</a></li>
    <li><a href="/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<article class="post">
		<a href="#"><h1 class="post-title">Writing Mac Apps in Go</h1></a>
<div class="post-line"></div>
		<div class="post-info">
    
</div>
		


		

<p>Go makes it easy to create safe, reliable and efficient software. Concurrency is part of the language, making otherwise complicated code more intuitive to write. It can compile binaries for any non-obscure platform and has a quite capable standard library with a lively developer community.</p>

<p>Maybe I&rsquo;m just not very clever, but even after years of using <a href="https://en.wikipedia.org/wiki/Grand_Central_Dispatch">Grand Central Dispatch</a> (&ldquo;GCD&rdquo;), I still find it hard to write maintainable multi-threaded code.<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup> Although GCD offers a great improvement over how asynchronous code was written before Snow Leopard,<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup> I couldn&rsquo;t help but wonder what it would be like if I could focus on creating and designing APIs without having to worry about the minutiae of parallelism (threads, semaphores, locks, barriers, etc.).</p>

<p>All that to say, when I discovered a straight-forward and performant way to call Go code within a Mac app,<sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup> it felt like I unlocked new developer super-powers!</p>

<p>As a demonstration, let&rsquo;s build a library to escape/unescape HTML tags in Go and call it from Swift, one of the languages of choice when writing a native Mac app.</p>

<p><em>There&rsquo;s a complimentary project hosted on <a href="https://github.com/mikepulaski/go-swift">GitHub</a> if you&rsquo;re a &ldquo;hands on&rdquo; learner.</em></p>

<h2 id="go"><a href="#go">Writing a Go library</a></h2>

<h3 id="background">Background</h3>

<p>It&rsquo;s a pretty well-known feature that Go can call C code, but since Go 1.5, it&rsquo;s also possible to call Go code from C. The <code>go build</code> command has a <code>buildmode</code> flag to indicate what type of object should be built.</p>

<p>From <code>go help buildmode</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-buildmode=c-archive
   Build the listed main package, plus all packages it imports,
   into a C archive file. The only callable symbols will be those
   functions exported using a cgo //export comment. Requires
   exactly one main package to be listed.</code></pre></div>
<p>So what does this mean exactly? Well, if we can compile Go to C, and embed C libraries in our Mac app&hellip; well, I think we just found our golden ticket!</p>

<h3 id="go-archive"><a href="#go-archive">Write a C archive</a></h3>

<p>To write a C library in Go, we need to use cgo, the bridge between C and Go. For now, it&rsquo;s enough just to know that the C package can convert Go values to and from C types, and vice-versa. If you want to dive-in a little deeper, the Go authors have written an excellent post about cgo on the <a href="https://blog.golang.org/c-go-cgo">Go Blog</a>.</p>

<p>As mentioned previously, to build a C archive, we need to create a main package and mark each method we want to export with a preceding <code>//export</code> cgo comment.</p>

<p>The entire library would look something like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;C&#34;</span>
	<span class="s">&#34;html&#34;</span>
<span class="p">)</span>

<span class="c1">//export escape_html
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">escape_html</span><span class="p">(</span><span class="nx">input</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">EscapeString</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
	<span class="k">return</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//export unescape_html
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">unescape_html</span><span class="p">(</span><span class="nx">input</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">UnescapeString</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
	<span class="k">return</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// We need an entry point; it&#39;s ok for this to be empty
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{}</span></code></pre></div>
<p>Notice that we also had to convert between C and Go strings using cgo, and only exposed C types in the method signatures.</p>

<h3 id="go-compile"><a href="#go-compile">Compile the archive</a></h3>

<p>Assuming you&rsquo;re in the same directory as the Go source, the library can be compiled using the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go build --buildmode<span class="o">=</span>c-archive -o libhtmlescaper.a</code></pre></div>
<p>We&rsquo;ve specified an explicit name and extension to use for our library, which helps makes it a little easier to bundle for use in Xcode. The build will also output a generated header<sup class="footnote-ref" id="fnref:4"><a href="#fn:4">4</a></sup> <code>libhtmlescaper.h</code> which exposes all of the exported functions / types available when linking the archive.</p>

<h2 id="swift"><a href="#swift">Calling Go from Swift</a></h2>

<h3 id="swift-module-map"><a href="#swift-module-map">Create a module map</a></h3>

<p>The easiest way to use our compiled library from Swift is to create a <a href="https://clang.llvm.org/docs/Modules.html#id21">module map</a>. Once setup correctly (which honestly, can be painful), our library will be automatically linked, with its headers included, when imported.</p>

<p>Here&rsquo;s what part of our <code>module.modulemap</code> might look like:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">module</span> <span class="n">HTMLEscaper</span> <span class="p">{</span>
    <span class="n">header</span> <span class="s">&#34;libhtmlescaper.h&#34;</span>
    <span class="n">link</span> <span class="s">&#34;htmlescaper&#34;</span>
    <span class="n">export</span> <span class="o">*</span>
<span class="p">}</span></code></pre></div>
<p>If you don&rsquo;t already have module maps setup for your project, you should save your module map in your Xcode project&rsquo;s <code>$(SRCROOT)</code> (the same directory as your <code>.xcodeproj</code> file). Afterwards, you&rsquo;ll need to update your target&rsquo;s build settings: set <code>LIBRARY_SEARCH_PATHS</code> and <code>SWIFT_INCLUDE_PATHS</code> to <code>$(SRCROOT)</code>.</p>

<p>I&rsquo;ll admit, there can be little bit of friction here, but no more than if you were to use other third-party libraries in Swift.</p>

<h3 id="swift-wrapper"><a href="#swift-wrapper">Create a wrapper</a></h3>

<p>If we&rsquo;ve setup our module correctly and Xcode is on its best behavior, all we need to do is import it.</p>

<p>Here&rsquo;s what it might look like if we wrote a <code>String</code> extension to escapes HTML using our library:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">HTMLEscaper</span>

<span class="kd">extension</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">escapedHTMLString</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">withCString</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">v</span> <span class="p">=</span> <span class="n">escape_html</span><span class="p">(</span><span class="nb">UnsafeMutablePointer</span><span class="p">(</span><span class="kr">mutating</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="n">bytesNoCopy</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">,</span> <span class="n">freeWhenDone</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">unescapedHTMLString</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">withCString</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">v</span> <span class="p">=</span> <span class="n">unescape_html</span><span class="p">(</span><span class="nb">UnsafeMutablePointer</span><span class="p">(</span><span class="kr">mutating</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="n">bytesNoCopy</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">,</span> <span class="n">freeWhenDone</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>And that&rsquo;s it! Our Go library is now just an implementation detail, and the Swift API feels right at home.</p>

<h2 id="value"><a href="#value">Was that really worth it?</a></h2>

<p>Really, it depends on your project.</p>

<p>For <a href="https://emporter.app">Emporter</a>, its backend services are written in Go. By writing the client in Go, I have an easy way to run tests, without mocks, instantaneously. I seriously can&rsquo;t imagine having written it differently as a one-person project, based on the amount of time I&rsquo;ve saved by keeping all of the networking code in a single repo (then exporting the client as a C library).</p>

<p>And if I ever grow enough to hire, expand to a different platform, or license the service, I&rsquo;m ready: its core can be developed independently and works cross-platform.</p>

<p>Give <a href="https://emporter.app">Emporter</a> a try and let me know how it compares to an Electron app. 😉</p>

<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>

<p>In this article, we&rsquo;ve written a simple Go library which was embedded in a native Mac app. Although we&rsquo;ve focused on macOS, this technique will work for any platform that Go supports with C bindings.</p>

<p>You can download an example project on <a href="https://github.com/mikepulaski/go-swift">GitHub</a>.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">The subtleties required to implement coordination between routines and access to shared variables, especially after periods of inactivity in the codebase, is hard.
 <a class="footnote-return" href="#fnref:1">↩︎︎</a></li>
<li id="fn:2">Back in my day, we called macOS &ldquo;OS X&rdquo;. And we managed <code>NSThread</code> and <code>NSRunLoop</code> instances ourselves. Get off my lawn! 👴
 <a class="footnote-return" href="#fnref:2">↩︎︎</a></li>
<li id="fn:3">Go code is also embeddable on on iOS, Android and/or Windows.
 <a class="footnote-return" href="#fnref:3">↩︎︎</a></li>
<li id="fn:4">The generated header is not very easy to read. In real projects, I tend to write my own headers for well-documented code.
 <a class="footnote-return" href="#fnref:4">↩︎︎</a></li>
</ol>
</div>

	</article>

	<section class="pagination">
		
		 <a href="/posts/gdpr-is-an-asset/" class="left arrow">&#8592;</a>
		
		

		<div class="post-info">
	
    <time datetime="2019-01-11 09:44:45 &#43;0100 CET">January 11, 2019</time>
	
</div>
	</section>
</main>


        		<footer>
			<span>
				&copy; <time datetime="2019-01-21 23:55:04.124817 &#43;0100 CET m=&#43;0.172598282">2019</time> Young Dynasty EURL
				&middot;
				<a href="https://twitter.com/YoungDynastyNet">@YoungDynastyNet</a>
			</span>
		</footer>
		
    </body>
</html>
